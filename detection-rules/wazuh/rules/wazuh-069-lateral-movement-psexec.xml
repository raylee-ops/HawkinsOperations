<!--
  Wazuh Rule: Lateral Movement via PsExec
  ID: 100069
  Level: 10 (High)
  Description: Detects PsExec service installation and execution for lateral movement
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,lateral_movement,">
  <rule id="100069" level="10">
    <if_sid>60000</if_sid>
    <field name="win.system.eventID">^7045$</field>
    <field name="win.eventdata.serviceName">PSEXESVC</field>
    <description>PsExec service detected - Possible lateral movement</description>
    <mitre>
      <id>T1570</id>
    </mitre>
    <group>psexec,lateral_movement,</group>
  </rule>

  <rule id="100069001" level="12" frequency="3" timeframe="600">
    <if_matched_sid>100069</if_matched_sid>
    <description>Multiple PsExec service installations across hosts - Active lateral movement</description>
    <mitre>
      <id>T1570</id>
    </mitre>
    <group>psexec,lateral_movement,mass_compromise,</group>
  </rule>
</group>

<!--
Summary:
  Detects PSEXESVC service installation (Event 7045) which indicates PsExec remote execution.
  Elevated severity when detected across multiple hosts within 10 minutes.

Fields Used:
  - win.eventdata.serviceName: Service name (PSEXESVC)
  - win.eventdata.imagePath: Service executable path
  - win.system.computer: Target hostname
  - win.eventdata.accountName: Service account

False Positives:
  - Legitimate IT administration using PsExec
  - Authorized remote management tools
  - System deployment activities
  - Troubleshooting and support operations

Severity: High (10), Critical (12 for multiple hosts)

MITRE ATT&CK: T1570 - Lateral Tool Transfer

Log Sources:
  - Windows System Event 7045 (Service Install)
  - Windows Security Event 4697 (Service Install)
  - Sysmon Event ID 1 (for PSEXESVC.exe execution)

Test Examples:
  - psexec \\\\target-host -u admin -p password cmd.exe
  - Service: PSEXESVC installed on remote host
  - Multiple hosts showing PSEXESVC installation in sequence

Tuning Notes:
  - Whitelist authorized IT staff and source IPs
  - Track PsExec usage patterns across environment
  - Correlate with authentication events (4624, 4625)
  - Alert on PsExec from non-admin workstations
  - Monitor for lateral movement chains across network
  - Implement application whitelisting to block unauthorized PsExec
  - Review user accounts performing remote execution
-->
