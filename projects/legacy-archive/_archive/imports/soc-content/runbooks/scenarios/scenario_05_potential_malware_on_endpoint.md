# Scenario 05: Potential Malware Detected on Endpoint

## Environment Context
- **Primary Detection**: Wazuh SIEM, Windows Defender, Sysmon, behavior analysis
- **Affected System**: Any HawkinsOps endpoint (Windows Powerhouse, MINT-3, PRIMARY_OS)
- **HawkinsOps Components Involved**:
  - Infected endpoint
  - Wazuh server (detection/alerting)
  - pfSense (network isolation, C2 blocking)
  - Clean analysis workstation

## Detection

### Detection Methods

**Wazuh Alerts:**
- **Rule ID**: 87104 (Windows Defender malware detection)
- **Rule ID**: 554 (File integrity monitoring - suspicious modification)
- **Rule ID**: 61603 (Sysmon - suspicious process creation)
- **Custom rules**: Unusual network connections, registry modifications

**Windows Indicators:**
- Windows Defender alerts
- Sysmon process creation anomalies (Event ID 1)
- Unexpected network connections (Sysmon Event ID 3)
- Auto-start persistence (Sysmon Event IDs 12, 13)
- Suspicious file creation (Sysmon Event ID 11)

**Linux Indicators:**
- ClamAV alerts (if deployed)
- Unknown processes running
- Unexpected cron jobs
- Modified system binaries
- Unusual network connections

**Behavioral Indicators:**
- System slowdown
- Unexpected pop-ups or redirects
- Disabled security software
- Unknown processes consuming resources
- Outbound connections to suspicious IPs

## Triage Steps

1. **Review Initial Alert**
   - Note malware name/signature (if AV detected)
   - File path and hash
   - Detection timestamp
   - User context

2. **Initial Endpoint Assessment - DO NOT REBOOT**

   **Windows:**
   ```powershell
   # Check Windows Defender status and threats:
   Get-MpComputerStatus
   Get-MpThreatDetection

   # Review recent Defender activity:
   Get-WinEvent -LogName 'Microsoft-Windows-Windows Defender/Operational' -MaxEvents 50

   # Check running processes:
   Get-Process | Sort-Object CPU -Descending | Select-Object -First 20

   # Identify unsigned or suspicious executables:
   Get-Process | Where-Object {$_.Path -ne $null} | ForEach-Object {
     [PSCustomObject]@{
       Name = $_.Name
       Path = $_.Path
       Signed = (Get-AuthenticodeSignature $_.Path).Status
     }
   } | Where-Object {$_.Signed -ne 'Valid'}
   ```

   **Linux:**
   ```bash
   # Check running processes:
   ps auxf | less

   # Identify unusual processes:
   ps aux --sort=-%cpu | head -20

   # Check for processes running from /tmp or /dev/shm:
   lsof +D /tmp
   lsof +D /dev/shm

   # Active network connections:
   sudo netstat -antp | grep ESTABLISHED
   # OR:
   sudo ss -tnp | grep ESTABLISHED
   ```

3. **Identify Suspicious Files**

   **Windows:**
   ```powershell
   # Recently created executables:
   Get-ChildItem -Path C:\ -Include *.exe,*.dll,*.scr,*.bat,*.ps1 -Recurse -ErrorAction SilentlyContinue |
     Where-Object {$_.CreationTime -gt (Get-Date).AddDays(-1)} |
     Select-Object FullName, CreationTime, Length

   # Files in suspicious locations:
   Get-ChildItem -Path C:\Users\*\AppData\Local\Temp,C:\Windows\Temp -Include *.exe,*.dll -Recurse -ErrorAction SilentlyContinue

   # Calculate file hash for analysis:
   Get-FileHash -Path "<suspicious_file>" -Algorithm SHA256
   ```

   **Linux:**
   ```bash
   # Recently modified files:
   sudo find / -type f -mtime -1 -ls 2>/dev/null | grep -E '\.sh$|\.elf$|/tmp/|/dev/shm/'

   # Check for hidden files in unusual places:
   sudo find /tmp /var/tmp /dev/shm -name ".*" -type f

   # Calculate file hash:
   sha256sum <suspicious_file>
   ```

4. **Check File Reputation**
   ```bash
   # On PRIMARY_OS:
   # Submit hash to VirusTotal:
   # https://www.virustotal.com/gui/home/search

   # Check hash in threat intelligence feeds:
   # AlienVault OTX, Hybrid Analysis, ANY.RUN
   ```

5. **Analyze Network Activity**

   **Windows:**
   ```powershell
   # Current network connections:
   Get-NetTCPConnection -State Established |
     Select-Object LocalAddress, LocalPort, RemoteAddress, RemotePort, OwningProcess,
     @{Name='ProcessName';Expression={(Get-Process -Id $_.OwningProcess).Name}}

   # Check Sysmon network events (Event ID 3):
   Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-Sysmon/Operational';ID=3} -MaxEvents 100 |
     Select-Object TimeCreated, @{Name='Process';Expression={$_.Properties[4].Value}},
     @{Name='DestIP';Expression={$_.Properties[14].Value}},
     @{Name='DestPort';Expression={$_.Properties[16].Value}}
   ```

   **Linux:**
   ```bash
   # Active connections with process info:
   sudo lsof -i -n -P | grep ESTABLISHED

   # Check for connections to unusual ports:
   sudo netstat -antp | grep -E ':[4-9][0-9]{3,4} ' | grep ESTABLISHED
   ```

6. **Check for Persistence Mechanisms**

   **Windows:**
   ```powershell
   # Registry Run keys:
   Get-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\Run'
   Get-ItemProperty -Path 'HKCU:\Software\Microsoft\Windows\CurrentVersion\Run'
   Get-ItemProperty -Path 'HKLM:\Software\Microsoft\Windows\CurrentVersion\RunOnce'

   # Scheduled tasks:
   Get-ScheduledTask | Where-Object {$_.State -ne 'Disabled'} |
     Select-Object TaskName, TaskPath, @{Name='Action';Expression={$_.Actions.Execute}}

   # Services:
   Get-Service | Where-Object {$_.Status -eq 'Running' -and $_.StartType -eq 'Automatic'} |
     Select-Object Name, DisplayName, @{Name='Path';Expression={(Get-WmiObject Win32_Service -Filter "Name='$($_.Name)'").PathName}}

   # Startup folder:
   Get-ChildItem -Path 'C:\ProgramData\Microsoft\Windows\Start Menu\Programs\Startup' -Force
   Get-ChildItem -Path "$env:APPDATA\Microsoft\Windows\Start Menu\Programs\Startup" -Force

   # WMI event subscriptions (advanced persistence):
   Get-WmiObject -Namespace root\subscription -Class __EventFilter
   Get-WmiObject -Namespace root\subscription -Class CommandLineEventConsumer
   ```

   **Linux:**
   ```bash
   # Cron jobs:
   crontab -l
   sudo crontab -l
   sudo cat /etc/crontab
   sudo ls -la /etc/cron.*

   # Systemd services and timers:
   systemctl list-unit-files --type=service --state=enabled
   systemctl list-timers --all

   # Init scripts:
   ls -la /etc/init.d/

   # Shell profiles:
   cat ~/.bashrc ~/.bash_profile ~/.profile /etc/profile

   # Modified system binaries (compare with package manager):
   sudo debsums -c  # Debian/Ubuntu
   ```

## Investigation Checklist

- [ ] AV/EDR detected specific malware family?
- [ ] Hash matches known malware in threat intel?
- [ ] Suspicious process still running?
- [ ] Outbound C2 connections active?
- [ ] Persistence mechanisms identified?
- [ ] User reports phishing email or suspicious download?
- [ ] Malware spread to other systems (worm behavior)?
- [ ] Data exfiltration detected?
- [ ] System files modified (rootkit indicators)?
- [ ] Security tools disabled or tampered with?
- [ ] Multiple infection vectors present?

## Containment Actions

### IMMEDIATE ACTIONS:

1. **Network Isolation** (PRIORITY - prevent spread and C2)

   **Windows:**
   ```powershell
   # Disable all network adapters:
   Get-NetAdapter | Disable-NetAdapter -Confirm:$false
   ```

   **Linux:**
   ```bash
   # Bring down all network interfaces except loopback:
   sudo ip link set eth0 down
   sudo ip link set wlan0 down
   ```

   **At pfSense:**
   - Create firewall rule blocking infected host's IP
   - Monitor for other hosts contacting same C2 IPs

2. **Suspend Suspicious Processes** (capture memory first if possible)

   **Windows:**
   ```powershell
   # DO NOT kill immediately - capture memory dump first:
   # Using ProcDump (SysInternals):
   procdump.exe -ma <PID> C:\temp\malware_dump.dmp

   # Then kill:
   Stop-Process -Id <PID> -Force
   ```

   **Linux:**
   ```bash
   # Create memory dump:
   sudo gcore <PID>

   # Then kill:
   sudo kill -9 <PID>
   ```

3. **Preserve Evidence BEFORE Cleanup**
   - See "Evidence to Capture" section below
   - DO NOT run cleanup tools until evidence secured

4. **Quarantine Malicious Files**

   **Windows:**
   ```powershell
   # Move to quarantine folder:
   New-Item -Path C:\Quarantine -ItemType Directory -Force
   Move-Item -Path "<malware_path>" -Destination C:\Quarantine\
   ```

   **Linux:**
   ```bash
   sudo mkdir -p /quarantine
   sudo mv <malware_path> /quarantine/
   sudo chmod 000 /quarantine/*
   ```

### REMEDIATION:

1. **Run Full Antivirus Scan**

   **Windows:**
   ```powershell
   # Windows Defender full scan:
   Start-MpScan -ScanType FullScan

   # Check scan progress:
   Get-MpComputerStatus
   ```

   **Linux:**
   ```bash
   # Install ClamAV if not present:
   sudo apt update && sudo apt install clamav clamav-daemon

   # Update signatures:
   sudo freshclam

   # Full scan:
   sudo clamscan -r --infected --remove /
   ```

2. **Remove Persistence Mechanisms**
   - Delete malicious scheduled tasks, services, registry keys
   - Remove from startup locations
   - Verify removal with second check

3. **Reset Compromised Credentials**
   - Change passwords for any accounts used on infected system
   - Revoke and reissue authentication tokens/certificates

4. **Consider Full Rebuild**
   - If rootkit suspected or extensive compromise
   - Document decision rationale

## Evidence to Capture

### CRITICAL - Capture BEFORE remediation:

1. **Memory Dump**
   ```powershell
   # Windows - full memory dump using DumpIt or WinPmem:
   # Or live RAM dump with Magnet RAM Capture

   # Or at minimum, process dumps of suspicious processes:
   procdump.exe -ma <PID> C:\Forensics\process_<PID>.dmp
   ```

2. **Disk Image** (if feasible)
   - Use FTK Imager or dd for forensic image
   - Or at minimum, copy suspicious files with metadata

3. **Malware Sample**
   ```powershell
   # Windows:
   Copy-Item <malware_path> C:\Forensics\malware_sample.bin
   Get-FileHash C:\Forensics\malware_sample.bin -Algorithm SHA256

   # Linux:
   sudo cp <malware_path> /forensics/malware_sample
   sha256sum /forensics/malware_sample
   ```

4. **Process List with Details**
   ```powershell
   # Windows:
   Get-Process | Select-Object Name, Id, Path, StartTime, Company |
     Export-Csv C:\Forensics\processes.csv

   # Or use Process Explorer: File → Save → Save All

   # Linux:
   ps auxf > /forensics/process_tree.txt
   sudo lsof > /forensics/open_files.txt
   ```

5. **Network Connections**
   ```powershell
   # Windows:
   Get-NetTCPConnection | Export-Csv C:\Forensics\network_connections.csv

   # Capture live traffic:
   # Use Wireshark or pktmon

   # Linux:
   sudo netstat -antp > /forensics/network_connections.txt
   sudo tcpdump -i any -w /forensics/traffic.pcap -c 10000
   ```

6. **Event Logs**
   ```powershell
   # Windows - export Security, System, Application, Sysmon:
   wevtutil epl Security C:\Forensics\Security.evtx
   wevtutil epl System C:\Forensics\System.evtx
   wevtutil epl Application C:\Forensics\Application.evtx
   wevtutil epl "Microsoft-Windows-Sysmon/Operational" C:\Forensics\Sysmon.evtx
   wevtutil epl "Microsoft-Windows-PowerShell/Operational" C:\Forensics\PowerShell.evtx

   # Linux:
   sudo cp -r /var/log /forensics/logs_backup
   ```

7. **Persistence Locations**
   ```powershell
   # Windows - export registry hives:
   reg export HKLM\Software\Microsoft\Windows\CurrentVersion\Run C:\Forensics\reg_run.reg
   reg export HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce C:\Forensics\reg_runonce.reg

   # Export scheduled tasks:
   schtasks /query /fo CSV /v > C:\Forensics\scheduled_tasks.csv

   # Linux:
   sudo cp /etc/crontab /forensics/
   sudo cp -r /etc/cron.* /forensics/
   ```

8. **Prefetch, Recent Files, Browser History**
   ```powershell
   # Windows:
   Copy-Item C:\Windows\Prefetch\* C:\Forensics\Prefetch\
   # Recent files and jump lists:
   Copy-Item $env:APPDATA\Microsoft\Windows\Recent\* C:\Forensics\Recent\
   ```

9. **Transfer Evidence to Safe Location**
   ```bash
   # From infected endpoint to PRIMARY_OS:
   # Use USB drive (offline transfer) or SCP if network available

   # Copy to HawkinsOps:
   # ~/HAWKINS_OPS/incidents/YYYY-MM-DD_malware_<hostname>/
   ```

## Closure & Lessons Learned

### Ticket Closure Steps:
1. Verify malware fully removed (rescan with multiple tools)
2. Confirm no persistence mechanisms remain
3. Validate network connectivity restored and clean
4. Submit malware sample to AV vendors (if new/unknown)
5. Update threat intelligence with IOCs
6. Document infection vector (phishing, drive-by, USB, etc.)
7. Archive all forensic evidence
8. Close Wazuh alert with detailed findings

### Hardening Recommendations:
- **Deploy EDR solution** for enhanced detection and response
- **Enable Windows Defender Attack Surface Reduction (ASR) rules**
- **Implement application whitelisting** (AppLocker/WDAC)
- **Deploy Sysmon** with SwiftOnSecurity config for enhanced logging
- **Enable PowerShell logging** (script block + module logging)
- **Configure Wazuh FIM** to monitor critical directories
- **Deploy network segmentation** to limit lateral movement
- **Implement email security** (sandbox attachments, block macros)
- **Web filtering at pfSense** (pfBlockerNG)
- **Regular patch management** for OS and applications
- **User security awareness training** (phishing simulations)
- **Endpoint hardening**:
  - Disable unnecessary services
  - Remove local admin rights from standard users
  - Enable AMSI for script scanning
- **Backup validation** - ensure clean backups exist
- **Incident response plan** review and update

### Portfolio Notes:
- Demonstrates malware analysis and incident response workflow
- Shows forensic evidence collection skills
- Highlights containment prioritization (network isolation first)
- Emphasizes preservation before remediation
- Understanding of persistence mechanisms across Windows and Linux
